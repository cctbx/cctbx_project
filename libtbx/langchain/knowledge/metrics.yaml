# =============================================================================
# PHENIX AI Agent - Metrics Definitions
# =============================================================================
# This file defines all metrics the agent tracks and uses for decisions.
#
# Each metric specifies:
#   - What it measures (description)
#   - Whether higher or lower is better (direction)
#   - Quality thresholds (good, acceptable, poor)
#   - How to extract it from logs (patterns)
#
# To add a new metric, copy an existing entry and modify it.
# =============================================================================

# -----------------------------------------------------------------------------
# REFINEMENT METRICS (X-ray)
# -----------------------------------------------------------------------------

r_free:
  description: "Cross-validation R-factor - measures model quality against unseen data"
  type: float
  direction: minimize  # Lower is better
  unit: ""
  format: "{:.4f}"

  thresholds:
    good: 0.22
    acceptable: 0.28
    poor: 0.35

  # Resolution-dependent targets
  by_resolution:
    - range: [0.0, 1.5]
      good: 0.18
      acceptable: 0.22
      poor: 0.28
    - range: [1.5, 2.0]
      good: 0.20
      acceptable: 0.25
      poor: 0.30
    - range: [2.0, 2.5]
      good: 0.22
      acceptable: 0.27
      poor: 0.32
    - range: [2.5, 3.0]
      good: 0.25
      acceptable: 0.30
      poor: 0.35
    - range: [3.0, 999]
      good: 0.28
      acceptable: 0.33
      poor: 0.38

  extraction:
    patterns:
      - 'R-free\s*[=:]\s*([0-9.]+)'
      - 'Rfree\s*[=:]\s*([0-9.]+)'
      - 'RFREE\s+([0-9.]+)'  # Autobuild table format


r_work:
  description: "Working R-factor - measures fit to data used in refinement"
  type: float
  direction: minimize
  unit: ""
  format: "{:.4f}"

  thresholds:
    good: 0.18
    acceptable: 0.22
    poor: 0.28

  extraction:
    patterns:
      - 'R-work\s*[=:]\s*([0-9.]+)'
      - 'Rwork\s*[=:]\s*([0-9.]+)'


# -----------------------------------------------------------------------------
# REFINEMENT METRICS (Cryo-EM)
# -----------------------------------------------------------------------------

map_cc:
  description: "Map-model correlation coefficient"
  type: float
  direction: maximize  # Higher is better
  unit: ""
  format: "{:.3f}"

  thresholds:
    good: 0.80
    acceptable: 0.70
    poor: 0.60

  extraction:
    patterns:
      - 'CC_mask\s*[=:]\s*([0-9.]+)'
      - 'map.model.CC\s*[=:]\s*([0-9.]+)'
      - 'CC\s*[=:]\s*([0-9.]+)'


# -----------------------------------------------------------------------------
# MOLECULAR REPLACEMENT METRICS
# -----------------------------------------------------------------------------

tfz:
  description: "Translation Function Z-score - measures MR solution quality"
  type: float
  direction: maximize
  unit: ""
  format: "{:.1f}"

  thresholds:
    good: 12.0      # Strong solution
    acceptable: 8.0  # Likely correct
    poor: 5.0       # Marginal

  interpretation:
    - range: [15, 999]
      meaning: "Excellent - highly confident solution"
    - range: [8, 15]
      meaning: "Good - likely correct solution"
    - range: [5, 8]
      meaning: "Marginal - may need verification"
    - range: [0, 5]
      meaning: "Poor - solution probably incorrect"

  extraction:
    patterns:
      - 'TFZ==?([0-9.]+)'
    extract: last  # Take last value (final refined TFZ)


llg:
  description: "Log-likelihood Gain - statistical quality of MR solution"
  type: float
  direction: maximize
  unit: ""
  format: "{:.0f}"

  thresholds:
    good: 100
    acceptable: 50
    poor: 20

  extraction:
    patterns:
      - 'LLG=([0-9.]+)'
    extract: last


rfz:
  description: "Rotation Function Z-score - measures rotation search quality"
  type: float
  direction: maximize
  unit: ""
  format: "{:.1f}"

  thresholds:
    good: 6.0       # Strong rotation signal
    acceptable: 4.0  # Promising rotation
    poor: 3.0       # Marginal

  interpretation:
    - range: [8, 999]
      meaning: "Excellent - very strong rotation signal"
    - range: [5, 8]
      meaning: "Good - clear rotation solution"
    - range: [3, 5]
      meaning: "Marginal - may need better search model"
    - range: [0, 3]
      meaning: "Poor - rotation search failed"

  extraction:
    patterns:
      - 'RFZ=([0-9.]+)'

  notes: |
    RFZ is evaluated before TFZ during molecular replacement.
    A good RFZ indicates the search model orientation is correct.
    TFZ is generally more decisive for solution quality.


# -----------------------------------------------------------------------------
# GEOMETRY METRICS
# -----------------------------------------------------------------------------

clashscore:
  description: "Steric clashes per 1000 atoms"
  type: float
  direction: minimize
  unit: "clashes/1000 atoms"
  format: "{:.1f}"

  thresholds:
    good: 2
    acceptable: 5
    poor: 10

  extraction:
    patterns:
      - '[Cc]lashscore\s*[=:]\s*([0-9.]+)'


ramachandran_favored:
  description: "Percentage of residues in favored Ramachandran regions"
  type: float
  direction: maximize
  unit: "%"
  format: "{:.1f}%"

  thresholds:
    good: 98
    acceptable: 95
    poor: 90

  extraction:
    patterns:
      - '[Rr]amachandran.*?favou?red\s*[=:]\s*([0-9.]+)'


ramachandran_outliers:
  description: "Percentage of residues in disallowed Ramachandran regions"
  type: float
  direction: minimize
  unit: "%"
  format: "{:.2f}%"

  thresholds:
    good: 0.2
    acceptable: 0.5
    poor: 1.0

  extraction:
    patterns:
      - '[Rr]amachandran.*?outliers?\s*[=:]\s*([0-9.]+)'


rotamer_outliers:
  description: "Percentage of residues with poor rotamers"
  type: float
  direction: minimize
  unit: "%"
  format: "{:.1f}%"

  thresholds:
    good: 0.5
    acceptable: 1.0
    poor: 2.0

  extraction:
    patterns:
      - '[Rr]otamer.*?outliers?\s*[=:]\s*([0-9.]+)'


bonds_rmsd:
  description: "RMS deviation of bond lengths from ideal"
  type: float
  direction: minimize
  unit: "Å"
  format: "{:.4f} Å"

  thresholds:
    good: 0.010
    acceptable: 0.015
    poor: 0.020

  extraction:
    patterns:
      - '[Bb]onds?\s*(?:RMSD)?\s*[=:]\s*([0-9.]+)'


angles_rmsd:
  description: "RMS deviation of bond angles from ideal"
  type: float
  direction: minimize
  unit: "°"
  format: "{:.2f}°"

  thresholds:
    good: 1.0
    acceptable: 1.5
    poor: 2.0

  extraction:
    patterns:
      - '[Aa]ngles?\s*(?:RMSD)?\s*[=:]\s*([0-9.]+)'


molprobity_score:
  description: "Overall MolProbity score (combines multiple metrics)"
  type: float
  direction: minimize
  unit: ""
  format: "{:.2f}"

  thresholds:
    good: 1.0
    acceptable: 1.5
    poor: 2.5

  extraction:
    patterns:
      - 'MolProbity score\s*[=:]\s*([0-9.]+)'


# -----------------------------------------------------------------------------
# DATA QUALITY METRICS
# -----------------------------------------------------------------------------

resolution:
  description: "High resolution limit of diffraction data or map"
  type: float
  direction: minimize  # Lower number = better resolution
  unit: "Å"
  format: "{:.2f} Å"

  thresholds:
    good: 2.0
    acceptable: 3.0
    poor: 4.0

  extraction:
    patterns:
      - 'High resolution limit\s*[=:]\s*([0-9.]+)'
      - 'd_fsc_model(?:_05|_0.5)?[=:\s]+([0-9.]+)'
      - 'd99[=:\s]+([0-9.]+)'
      - '[Rr]esolution\s*[=:]\s*([0-9.]+)\s*[AÅ]?'


completeness:
  description: "Percentage of theoretically possible reflections measured"
  type: float
  direction: maximize
  unit: "%"
  format: "{:.1f}%"

  thresholds:
    good: 99
    acceptable: 95
    poor: 90

  extraction:
    patterns:
      - '[Cc]ompleteness\s*[=:]\s*([0-9.]+)'


# -----------------------------------------------------------------------------
# SPECIAL CONDITION METRICS
# -----------------------------------------------------------------------------

twinning:
  description: "Whether crystal twinning is detected"
  type: boolean

  extraction:
    patterns:
      - 'No twinning suspected'  # If found, twinning = false
    invert: true  # Absence of pattern means twinning possible


twin_fraction:
  description: "Estimated twin fraction (Britton alpha)"
  type: float
  direction: minimize  # Lower is better (less twinning)
  unit: ""
  format: "{:.3f}"

  thresholds:
    good: 0.05      # Negligible twinning
    acceptable: 0.20 # Some twinning
    poor: 0.40      # Severe twinning

  extraction:
    patterns:
      - '(?:Britton alpha|Twin fraction)[:\s=]+([0-9.]+)'


twin_law:
  description: "Twin law operator if twinning detected"
  type: string

  extraction:
    patterns:
      - 'Twin law\s*[=:]\s*([^\n]+)'


anomalous_measurability:
  description: "Measurability of anomalous signal from xtriage (0-1 scale)"
  type: float
  direction: maximize  # Higher = stronger anomalous signal
  unit: ""
  format: "{:.3f}"

  thresholds:
    good: 0.10       # Strong signal, good for SAD/MAD
    acceptable: 0.05  # Moderate signal, SAD may be possible

  interpretation:
    - range: [0.10, 1.0]
      meaning: "Strong signal - good for SAD/MAD"
    - range: [0.05, 0.10]
      meaning: "Moderate signal - SAD possible"
    - range: [0, 0.05]
      meaning: "Weak signal - SAD unlikely to succeed"

  notes: |
    Measurability indicates the fraction of anomalous differences that are
    statistically significant. Values above 0.10 indicate strong anomalous
    signal suitable for experimental phasing.


# -----------------------------------------------------------------------------
# COMPOSITE QUALITY ASSESSMENT
# -----------------------------------------------------------------------------

quality_assessment:
  description: "Rules for determining overall model quality"

  # Model is "acceptable" if ALL required conditions met PLUS one refinement metric
  acceptable:
    required:
      - metric: clashscore
        operator: "<="
        threshold: acceptable
      - metric: ramachandran_outliers
        operator: "<="
        threshold: acceptable
    # Plus ONE of these refinement metrics
    any_of:
      - metric: r_free
        operator: "<="
        threshold: acceptable
      - metric: map_cc
        operator: ">="
        threshold: acceptable

  # Model is "good" if ALL required conditions met PLUS one refinement metric
  good:
    required:
      - metric: clashscore
        operator: "<="
        threshold: good
      - metric: ramachandran_outliers
        operator: "<="
        threshold: good
    any_of:
      - metric: r_free
        operator: "<="
        threshold: good
      - metric: map_cc
        operator: ">="
        threshold: good


# -----------------------------------------------------------------------------
# IMPROVEMENT DETECTION
# -----------------------------------------------------------------------------

improvement:
  description: "Thresholds for detecting significant improvement"

  # Minimum change to be considered "improvement"
  significant_change:
    r_free: 0.005     # 0.5% change
    r_work: 0.005
    map_cc: 0.01      # 1% change
    clashscore: 1.0

  # Plateau detection (not improving)
  plateau:
    cycles: 3         # Number of cycles to confirm plateau
    threshold: 0.003  # Less than 0.3% improvement = plateau


# =============================================================================
# BEST FILES SCORING
# =============================================================================
# Configuration for the Best Files Tracker scoring system.
#
# The tracker maintains knowledge of the highest-quality file of each type
# throughout a session. Files are scored based on:
#   - Processing stage (e.g., refined > docked > predicted)
#   - Quality metrics (e.g., R-free, map_cc, clashscore)
#
# Each category defines:
#   - stage_scores: Points awarded based on processing stage
#   - metric_scores: Additional points from quality metrics
#   - special_rules: Category-specific behavior (optional)
#
# Formula types:
#   - linear: Higher value is better (score increases with value)
#   - linear_inverse: Lower value is better (score increases as value decreases)
#   - boolean: True gives max_points, False gives 0
# =============================================================================

best_files_scoring:

  # ---------------------------------------------------------------------------
  # MODEL SCORING (0-200 points)
  # ---------------------------------------------------------------------------
  # Models are scored by refinement stage (0-100) plus metrics (0-100).
  # A fully refined model with good metrics can score up to 200 points.

  model:
    stage_scores:
      refined: 100           # Output from phenix.refine
      rsr_output: 100        # Output from real_space_refine
      autobuild_output: 80   # Output from phenix.autobuild
      docked: 60             # Output from dock_in_map
      processed_predicted: 50  # Processed AlphaFold model
      predicted: 40          # Raw AlphaFold prediction
      phaser_output: 30      # MR solution from Phaser
      pdb: 10                # Unknown/generic PDB
      _default: 10           # Fallback for unknown stages

    metric_scores:
      # R-free: Lower is better. Range 0.20 (best) to 0.40 (worst)
      # At r_free=0.20 -> 40 pts, r_free=0.30 -> 20 pts, r_free=0.40 -> 0 pts
      r_free:
        max_points: 40
        formula: linear_inverse
        best_value: 0.20
        worst_value: 0.40

      # Map-model CC: Higher is better. Range 0.0 to 1.0
      # At map_cc=1.0 -> 30 pts, map_cc=0.5 -> 15 pts
      map_cc:
        max_points: 30
        formula: linear
        best_value: 1.0
        worst_value: 0.0

      # Clashscore: Lower is better. Range 0 (best) to 20 (worst)
      # At clashscore=0 -> 30 pts, clashscore=10 -> 15 pts, clashscore=20 -> 0 pts
      clashscore:
        max_points: 30
        formula: linear_inverse
        best_value: 0
        worst_value: 20

  # ---------------------------------------------------------------------------
  # MAP SCORING (0-150 points)
  # ---------------------------------------------------------------------------
  # Maps are scored by processing stage (0-100) plus resolution (0-30).
  # Half-maps score low since they shouldn't be used as primary maps.

  map:
    stage_scores:
      optimized_full_map: 100  # Output from resolve_cryo_em
      sharpened: 90            # Output from map_sharpening
      density_modified: 80     # Density-modified map
      full_map: 50             # User-provided full map
      map: 40                  # Generic map
      half_map: 10             # Half-map (not suitable as primary)
      _default: 40

    metric_scores:
      # Resolution: Lower is better (higher resolution). Range 1.0 to 4.0 Å
      # At resolution=1.0 -> 30 pts, resolution=2.5 -> 15 pts, resolution=4.0 -> 0 pts
      resolution:
        max_points: 30
        formula: linear_inverse
        best_value: 1.0
        worst_value: 4.0

  # ---------------------------------------------------------------------------
  # MTZ SCORING (0-100 points)
  # ---------------------------------------------------------------------------
  # MTZ files have a special rule: the first MTZ with R-free flags locks
  # forever to ensure consistent R-free statistics throughout refinement.

  mtz:
    stage_scores:
      refined_mtz: 70    # Output from phenix.refine
      original: 50       # User-provided data
      mtz: 40            # Generic MTZ
      _default: 40

    metric_scores:
      # Has R-free flags: Boolean - 30 points if true
      has_rfree_flags:
        max_points: 30
        formula: boolean

    special_rules:
      # Once an MTZ with R-free flags is found, it locks and cannot be replaced
      lock_on_rfree: true

  # ---------------------------------------------------------------------------
  # MAP COEFFICIENTS SCORING (0-100 points)
  # ---------------------------------------------------------------------------
  # Map coefficients from refinement. Prefer more recent refinement output.

  map_coefficients:
    stage_scores:
      refined: 80        # From latest refinement
      _default: 50

  # ---------------------------------------------------------------------------
  # SEQUENCE SCORING (0-50 points)
  # ---------------------------------------------------------------------------
  # Sequence files are simple - just track that we have one.

  sequence:
    stage_scores:
      _default: 50

  # ---------------------------------------------------------------------------
  # LIGAND CIF SCORING (0-50 points)
  # ---------------------------------------------------------------------------
  # Ligand restraint files - prefer user-provided over auto-generated.

  ligand_cif:
    stage_scores:
      user_provided: 60
      _default: 50
